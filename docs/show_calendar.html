<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario anual USC</title>

    <link href="https://unpkg.com/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      :root { color-scheme: light; }

      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #f5f7fb;
        font-family: "Segoe UI", Roboto, sans-serif;
        color: #1f2933;
      }

      #app {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.5rem 1rem 2rem;
      }

      #calendar {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
        padding: 1rem;
        height: calc(100vh - 220px);
        overflow: hidden;
      }

      .fc-daygrid-day-frame { padding: 0.1rem !important; min-height: 0 !important; }
      .fc-daygrid-day-top { padding-top: 2px !important; padding-bottom: 2px !important; }

      .legend {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        font-size: 0.95rem;
      }

      .legend-item { display: inline-flex; align-items: center; gap: 0.5rem; color: #475569; }
      .legend-color { width: 16px; height: 16px; border-radius: 4px; display: inline-block; box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.15); }
      .legend-color.vacaciones { background-color: #16a34a; }
      .legend-color.no-laboral { background-color: #9333ea; }

      .status-message { text-align: center; margin-top: 1rem; color: #64748b; font-size: 0.95rem; }
      .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

      .fc-daygrid-day.fc-day-sat, .fc-daygrid-day.fc-day-sun {
        background: linear-gradient(180deg, rgba(219, 234, 254, 0.25) 0%, rgba(219, 234, 254, 0.55) 100%);
      }
      .fc-daygrid-day.fc-day-sat .fc-daygrid-day-number,
      .fc-daygrid-day.fc-day-sun .fc-daygrid-day-number { color: #1d4ed8; font-weight: 600; }

      .fc .fc-toolbar.fc-header-toolbar { margin-bottom: 0.25rem; }
    </style>
  </head>

  <body>
    <div id="app">
      <h1 class="visually-hidden">Calendario anual de vacaciones y días no laborables</h1>

      <div class="legend" aria-hidden="true">
        <span class="legend-item"><span class="legend-color vacaciones"></span>Vacaciones</span>
        <span class="legend-item"><span class="legend-color no-laboral"></span>Día no laborable</span>
      </div>

      <div id="calendar" aria-label="Calendario anual"></div>
      <div id="status" class="status-message" role="status" aria-live="polite"></div>
    </div>

    <script>
      const tg = window.Telegram ? window.Telegram.WebApp : null;
      if (tg) tg.expand();

      const selectedDays = new Set();

      function toggleDaySelection(dateStr) {
        if (selectedDays.has(dateStr)) selectedDays.delete(dateStr);
        else selectedDays.add(dateStr);
      }

      function getSelectedArray() {
        return Array.from(selectedDays).sort();
      }

      function refreshMarkedDays(calendar) {
        calendar.getEventSources().forEach(src => src.remove());
        const events = getSelectedArray().map(d => ({
          start: d,
          end: d,
          display: "background",
          backgroundColor: "#16a34a88",
          allDay: true,
        }));
        calendar.addEventSource(events);
      }

      /***********************************
       * NEXT SCREEN
       ***********************************/
      function showNextScreen() {
        const container = document.getElementById("app");
        container.innerHTML = `
          <h2>Resumen selección</h2>
          <p>Días seleccionados: <strong>${selectedDays.size}</strong></p>

          <div>
            <label><input type="radio" name="tipo" value="op1" checked> Opción 1</label><br>
            <label><input type="radio" name="tipo" value="op2"> Opción 2</label><br>
            <label><input type="radio" name="tipo" value="op3"> Opción 3</label>
          </div>

          <button id="submitFinal"
                  style="margin-top:1rem;padding:0.6rem 1rem;border-radius:8px;
                         background:#1d4ed8;color:white;border:none;font-size:1rem;">
            Enviar al bot
          </button>

          <div id="finalStatus" style="margin-top:1rem;color:#64748b;"></div>
        `;

        document.getElementById("submitFinal").onclick = () => {
          const option = document.querySelector("input[name='tipo']:checked").value;

          const payload = {
            type: "calendar_final_submit",
            days: getSelectedArray(),
            option: option
          };

          tg.sendData(JSON.stringify(payload));
        };
      }

      /***********************************
       * MAIN SCREEN
       ***********************************/
      const TYPE_COLORS = { V: "#16a34a", N: "#9333ea" };

      function addDays(dateString, days) {
        const date = new Date(`${dateString}T00:00:00`);
        date.setDate(date.getDate() + days);
        return date.toISOString().slice(0, 10);
      }

      function normalizeEntries(rawEntries) {
        if (!Array.isArray(rawEntries)) return [];
        return rawEntries
          .filter((e) => typeof e === "string" && e.length >= 11)
          .map((t) => {
            const code = t[0];
            const [start, end] = t.slice(1).split(":", 2);
            return { code, start: start.slice(0, 10), end: (end || start).slice(0, 10) };
          })
          .filter((e) => TYPE_COLORS[e.code]);
      }

      function readCalendarData() {
        const params = new URLSearchParams(window.location.search);
        try {
          const raw = params.get("data");
          if (!raw) return { entries: [], error: "No se recibieron datos del calendario." };
          return { entries: normalizeEntries(JSON.parse(decodeURIComponent(raw))) };
        } catch {
          return { entries: [], error: "Los datos del calendario no tienen un formato válido." };
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const calendarContainer = document.getElementById("calendar");
        const statusElement = document.getElementById("status");
        const legendEl = document.querySelector(".legend");
        const appEl = document.getElementById("app");
        const today = new Date().toISOString().slice(0, 10);

        function calcContentHeight() {
          const appRect = appEl.getBoundingClientRect();
          const appStyles = getComputedStyle(appEl);
          const paddings = parseFloat(appStyles.paddingTop) + parseFloat(appStyles.paddingBottom);
          const used =
            appRect.top + paddings + (legendEl?.offsetHeight || 0) + 56 + 24;
          return Math.max(window.innerHeight - used, 320);
        }

        const calendar = new FullCalendar.Calendar(calendarContainer, {
          locale: "es",
          initialView: "dayGridMonth",
          initialDate: today,
          aspectRatio: 1.9,
          contentHeight: calcContentHeight(),
          expandRows: true,
          firstDay: 1,
          selectable: true,
          eventDisplay: "background",
          dayMaxEvents: true,
          headerToolbar: { start: "title", end: "prev,next,today" },
          buttonText: { today: "Hoy" },

          dateClick(info) {
            toggleDaySelection(info.dateStr);
            refreshMarkedDays(calendar);
          }
        });

        window.addEventListener("resize", () => {
          calendar.setOption("contentHeight", calcContentHeight());
          calendar.updateSize();
        });

        const { entries, error } = readCalendarData();
        if (error) statusElement.textContent = error;

        if (entries.length > 0) {
          calendar.addEventSource(
            entries.map((e) => ({
              start: e.start,
              end: addDays(e.end, 1),
              allDay: true,
              display: "background",
              backgroundColor: TYPE_COLORS[e.code],
              opacity: 0.6
            }))
          );
        }

        calendar.render();
        if (tg) tg.ready();

        /*********************
         * CONFIRM BUTTON
         *********************/
        const confirmBtn = document.createElement("button");
        confirmBtn.textContent = "Confirmar selección";
        confirmBtn.style = `
          margin-top:1rem;padding:0.7rem 1rem;border-radius:8px;
          background:#1d4ed8;color:white;border:none;font-size:1rem;width:100%;
        `;
        appEl.appendChild(confirmBtn);

        confirmBtn.onclick = () => {
          const payload = {
            type: "calendar_selection",
            days: getSelectedArray()
          };

          statusElement.textContent = "Enviando datos al bot...";
          statusElement.style.color = "#64748b";

          confirmBtn.disabled = true;
          confirmBtn.textContent = "Enviando…";

          tg.sendData(JSON.stringify(payload));
        };

        /*********************
         * GLOBAL TELEGRAM EVENTS
         *********************/
        if (tg) {
          tg.onEvent("web_app_data", (event) => {
            try {
              const data = JSON.parse(event.data);

              if (data.error) {
                statusElement.textContent = data.error;
                statusElement.style.color = "red";
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Confirmar selección";
                return;
              }

              statusElement.textContent = "✔ Datos enviados correctamente.";
              statusElement.style.color = "green";

              if (data.type === "calendar_selection") {
                showNextScreen();
              }

            } catch (err) {
              statusElement.textContent = "Error inesperado en la respuesta del bot.";
              statusElement.style.color = "red";
              confirmBtn.disabled = false;
              confirmBtn.textContent = "Confirmar selección";
            }
          });
        }

      });
    </script>
  </body>
</html>
